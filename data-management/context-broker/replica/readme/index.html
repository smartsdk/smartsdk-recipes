<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../../img/favicon.ico">
  <title>HA - SmartSDK Recipes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../../css/highlight.css">
  <link href="https://fiware.org/style/fiware_readthedocs.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "HA";
    var mkdocs_page_input_path = "data-management/context-broker/replica/readme.md";
    var mkdocs_page_url = "/data-management/context-broker/replica/readme/";
  </script>
  
  <script src="../../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../../.." class="icon icon-home"> SmartSDK Recipes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Recipes</span></li>

        
            
    <ul class="subnav">
    <li><span>Data/Context Management</span></li>

        
            
    <ul class="subnav">
    <li><span>Context Broker</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../readme/">Intro</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../simple/readme/">Simple</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">HA</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#orion-in-ha">Orion in HA</a></li>
                
                    <li><a class="toctree-l4" href="#how-to-use">How to use</a></li>
                
                    <li><a class="toctree-l4" href="#a-walkthrough">A walkthrough</a></li>
                
                    <li><a class="toctree-l4" href="#rescaling-orion">Rescaling Orion</a></li>
                
                    <li><a class="toctree-l4" href="#dealing-with-failures">Dealing with failures</a></li>
                
                    <li><a class="toctree-l4" href="#networks-considerations">Networks considerations</a></li>
                
                    <li><a class="toctree-l4" href="#open-interesting-issues">Open interesting issues:</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>IoT Services Enablement</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../../iot-services/readme/">IoT Broker</a>
        
    </li>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>Utils</span></li>

        
            
    <ul class="subnav">
    <li><span>Mongodb</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../../utils/mongodb/replica/readme/">Replica Set</a>
        
    </li>

        
    </ul>

        
    </ul>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../../tools/readme/">Tools</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../..">SmartSDK Recipes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Data/Context Management &raquo;</li>
        
      
        
          <li>Context Broker &raquo;</li>
        
      
    
    <li>HA</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/martel-innovate/smartsdk-recipes/edit/master/recipes/data-management/context-broker/replica/readme.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="orion-in-ha">Orion in HA</h1>
<p>This recipe shows how to deploy an scalable <a href="https://github.com/telefonicaid/fiware-orion/blob/master/README.md">Orion Context Broker</a> service backed with an scalable <a href="https://docs.mongodb.com/v3.2/replication/">replica set</a> of MongoDB instances.</p>
<p>All elements will be running in docker containers, defined in docker-compose files. Actually, this recipe focuses on the deployment of the Orion frontend, reusing the <a href="../../../../utils/mongodb/replica/readme/">mongodb replica recipe</a> for its backend.</p>
<p>The final deployment is represented by the following picture:</p>
<p><img src='http://g.gravizo.com/g?
  digraph G {
      rankdir=LR;
        compound=true;
        node [shape="record" style="filled"];
        splines=line;
        Client [fillcolor="aliceblue"];
        subgraph cluster {
            label="Docker Swarm Cluster";
            Internal_LB;
            subgraph cluster_0 {
                label="Orion Context Broker stack";
                Orion1 [fillcolor="aliceblue"];
                Orion2 [fillcolor="aliceblue"];
                Orion3 [fillcolor="aliceblue"];
            }
            subgraph cluster_1 {
                label="MongoDB Replica Set stack";
                Mongo1 [fillcolor="aliceblue"];
                Mongo2 [fillcolor="aliceblue"];
                Mongo3 [fillcolor="aliceblue"];
            }
        }
        Client -> Internal_LB [label="1026",lhead=cluster_0];
        Internal_LB -&gt; {Orion1,Orion2,Orion3};
        Orion1 -&gt; Mongo1 [lhead=cluster_1];
        Orion2 -&gt; Mongo1 [lhead=cluster_1];
        Orion3 -&gt; Mongo1 [lhead=cluster_1];
        Mongo1 -&gt; {Mongo2, Mongo3} [dir="both"];
  }
'&gt;</p>
<p><em>IMPORTANT:</em> As explained in the <a href="../../../../utils/mongodb/replica/readme/">mongo replica recipe</a>, that recipe is not ready for production deployments for security reasons. Look at the <em>"Further Improvements"</em> section for more details.</p>
<h2 id="how-to-use">How to use</h2>
<p>Firstly, you need to have a Docker Swarm (docker &gt;= 1.13) already setup. If you don't have one, checkout the <a href="../../../../tools/readme/">tools</a> section for a quick way to setup a local swarm.</p>
<pre><code>$ miniswarm start 3
$ eval $(docker-machine env ms-manager0)
</code></pre>
<p>Then, you need to deploy the <a href="../../../../utils/mongodb/replica/readme/">mongodb replica</a> stack.</p>
<pre><code>$ docker stack deploy -c ../../../utils/mongodb/replica/docker-compose.yml mongo-replica
</code></pre>
<p>A quick check to see if it was successfully deployed would be...</p>
<pre><code>$ docker service ls
ID            NAME                            MODE        REPLICAS  IMAGE
f081tcqr7rce  mongo-replica_mongo             global      3/3       mongo:latest
wq7quugr9b12  mongo-replica_mongo-controller  replicated  1/1       taliaga/mongo-replica-ctrl:latest
</code></pre>
<p>As shown above, if you see <em>3/3</em> in the replicas column it means the 3 replicas are up and running.</p>
<p>Now, you deploy the orion stack...</p>
<pre><code>$ docker stack deploy -c docker-compose.yml orion-stack
</code></pre>
<p>Allow some time until things get connected before querying for content. At some point, your deployment should look like this...</p>
<pre><code>$ docker service ls
ID            NAME                            MODE        REPLICAS  IMAGE
0ykzt0fjswz2  orion-stack_orion               replicated  3/3       fiware/orion:1.3.0
f081tcqr7rce  mongo-replica_mongo             global      3/3       mongo:latest
wq7quugr9b12  mongo-replica_mongo-controller  replicated  1/1       taliaga/mongo-replica-ctrl:latest
</code></pre>
<p><em>IMPORANT</em>: If you want to change the names of the stacks, you can do it, but you must be careful to keep consistency in the references across the recipes updating this docker-compose file. For example, changing the name of the mongo replica stack could change the name of the network this recipe is expecting to connect to.</p>
<h2 id="a-walkthrough">A walkthrough</h2>
<p>You can check the distribution of the containers of a service (a.k.a tasks) through the swarm running the following...</p>
<pre><code>$ docker service ps context-broker_orion
ID            NAME                    IMAGE               NODE         DESIRED STATE  CURRENT STATE               ERROR  PORTS
vs1ew5yszca6  context-broker_orion.1  fiware/orion:1.3.0  ms-worker1   Running        Running about a minute ago         
2tibpye24o5q  context-broker_orion.2  fiware/orion:1.3.0  ms-manager0  Running        Running about a minute ago         
w9zmn8pp61ql  context-broker_orion.3  fiware/orion:1.3.0  ms-worker0   Running        Running about a minute ago
</code></pre>
<p>The good news is that, as you can see from the above output, by default docker already took care of deploying all the replicas of the service <em>context-broker_orion</em> to different hosts. Of course, with the use of labels, constraints or deploying mode you have the power to customize the distribution of tasks among swarm nodes. You can see the <a href="../../../../utils/mongodb/replica">mongo replica recipe</a> to understand the deployment of the <em>mongo-replica_mongo</em> service.</p>
<p>Now, let's query Orion to check it's truly up and running. The question now is... where is Orion actually running? We'll cover the network internals later, but for now let's query the manager node...</p>
<pre><code>$ sh ../query.sh $(docker-machine ip ms-manager0)
</code></pre>
<p>You will get something like...</p>
<pre><code>{
  "orion" : {
  "version" : "1.3.0",
  "uptime" : "0 d, 0 h, 18 m, 13 s",
  "git_hash" : "cb6813f044607bc01895296223a27e4466ab0913",
  "compile_time" : "Fri Sep 2 08:19:12 UTC 2016",
  "compiled_by" : "root",
  "compiled_in" : "ba19f7d3be65"
}
}
[]
</code></pre>
<p>Thanks to the docker swarm internal routing mesh, you can actually perform the previous query to any node of the swarm, it will be redirected to a node where the request on port 1026 can be attended (i.e, any node running Orion).</p>
<p>Let's insert some data...</p>
<pre><code>$ sh ../insert.sh $(docker-machine ip ms-worker1)
</code></pre>
<p>And check it's there...</p>
<pre><code>$ sh ../query.sh $(docker-machine ip ms-worker0)
...
[
    {
        "id": "Room1",
        "pressure": {
            "metadata": {},
            "type": "Integer",
            "value": 720
        },
        "temperature": {
            "metadata": {},
            "type": "Float",
            "value": 23
        },
        "type": "Room"
    }
]
</code></pre>
<p>Yes, you can query any of the three nodes.</p>
<p>Swarm's internal load balancer will be load-balancing in a round-robin approach all the requests for an orion service among the orion tasks running in the swarm.</p>
<h2 id="rescaling-orion">Rescaling Orion</h2>
<p>Scaling up and down orion is a simple as runnnig something like...</p>
<pre><code>$ docker service scale context-broker_orion=2
</code></pre>
<p>(this maps to the <em>"replicas"</em> argument in the docker-compose)</p>
<p>Consequently, one of the nodes (ms-worker1 in my case) is no longer running Orion...</p>
<pre><code>$ docker service ps context-broker_orion
ID            NAME                    IMAGE               NODE         DESIRED STATE  CURRENT STATE           ERROR  PORTS
2tibpye24o5q  context-broker_orion.2  fiware/orion:1.3.0  ms-manager0  Running        Running 11 minutes ago         
w9zmn8pp61ql  context-broker_orion.3  fiware/orion:1.3.0  ms-worker0   Running        Running 11 minutes ago
</code></pre>
<p>But still responds to the querying as mentioned above...</p>
<pre><code>$ sh ../query.sh $(docker-machine ip ms-worker1)
{
  "orion" : {
  "version" : "1.3.0",
  "uptime" : "0 d, 0 h, 14 m, 30 s",
  "git_hash" : "cb6813f044607bc01895296223a27e4466ab0913",
  "compile_time" : "Fri Sep 2 08:19:12 UTC 2016",
  "compiled_by" : "root",
  "compiled_in" : "ba19f7d3be65"
}
}
[]
</code></pre>
<p>You can see the <a href="../../../../utils/mongodb/replica">mongo replica recipe</a> to see how to scale the mongodb backend. But basically, due to the fact that it's a "global" service, you can scale it down like shown before, but scaling up requires adding a new node to the swarm.</p>
<h2 id="dealing-with-failures">Dealing with failures</h2>
<p>Docker is taking care of the reconciliation of the services in case a container goes down. Let's show this by running the following (always on the manager node):</p>
<pre><code>$ docker ps
CONTAINER ID        IMAGE                                                                                                COMMAND                  CREATED             STATUS              PORTS               NAMES
abc5e37037f0        fiware/orion@sha256:734c034d078d22f4479e8d08f75b0486ad5a05bfb36b2a1f1ba90ecdba2040a9                 "/usr/bin/contextB..."   2 minutes ago       Up 2 minutes        1026/tcp            orion-stack_orion.1.o9ebbardwvzn1gr11pmf61er8
1d79dca4ff28        taliaga/mongo-replica-ctrl@sha256:f53d1ebe53624dcf7220fe02b3d764f1b0a34f75cb9fff309574a8be0625553a   "python /src/repli..."   About an hour ago   Up About an hour                        mongo-replica_mongo-controller.1.xomw6zf1o0wq0wbut9t5jx99j
8ea3b24bee1c        mongo@sha256:0d4453308cc7f0fff863df2ecb7aae226ee7fe0c5257f857fd892edf6d2d9057                        "/usr/bin/mongod -..."   About an hour ago   Up About an hour    27017/tcp           mongo-replica_mongo.ta8olaeg1u1wobs3a2fprwhm6.3akgzz28zp81beovcqx182nkz
</code></pre>
<p>Suppose orion container goes down...</p>
<pre><code>$ docker rm -f abc5e37037f0
</code></pre>
<p>You will see it gone, but after a while it will automatically come back.</p>
<pre><code>$ docker ps
CONTAINER ID        IMAGE                                                                                                COMMAND                  CREATED             STATUS              PORTS               NAMES
1d79dca4ff28        taliaga/mongo-replica-ctrl@sha256:f53d1ebe53624dcf7220fe02b3d764f1b0a34f75cb9fff309574a8be0625553a   "python /src/repli..."   About an hour ago   Up About an hour                        mongo-replica_mongo-controller.1.xomw6zf1o0wq0wbut9t5jx99j
8ea3b24bee1c        mongo@sha256:0d4453308cc7f0fff863df2ecb7aae226ee7fe0c5257f857fd892edf6d2d9057                        "/usr/bin/mongod -..."   About an hour ago   Up About an hour    27017/tcp           mongo-replica_mongo.ta8olaeg1u1wobs3a2fprwhm6.3akgzz28zp81beovcqx182nkz

$ docker ps
CONTAINER ID        IMAGE                                                                                                COMMAND                  CREATED             STATUS                  PORTS               NAMES
60ba3f431d9d        fiware/orion@sha256:734c034d078d22f4479e8d08f75b0486ad5a05bfb36b2a1f1ba90ecdba2040a9                 "/usr/bin/contextB..."   6 seconds ago       Up Less than a second   1026/tcp            orion-stack_orion.1.uj1gghehb2s1gnoestup2ugs5
1d79dca4ff28        taliaga/mongo-replica-ctrl@sha256:f53d1ebe53624dcf7220fe02b3d764f1b0a34f75cb9fff309574a8be0625553a   "python /src/repli..."   About an hour ago   Up About an hour                            mongo-replica_mongo-controller.1.xomw6zf1o0wq0wbut9t5jx99j
8ea3b24bee1c        mongo@sha256:0d4453308cc7f0fff863df2ecb7aae226ee7fe0c5257f857fd892edf6d2d9057                        "/usr/bin/mongod -..."   About an hour ago   Up About an hour        27017/tcp           mongo-replica_mongo.ta8olaeg1u1wobs3a2fprwhm6.3akgzz28zp81beovcqx182nkz
</code></pre>
<p>Even if a whole node goes down, the service will remain working because you had both redundant orion instances and redundant db replicas.</p>
<pre><code>$ docker-machine rm ms-worker0
</code></pre>
<p>You will still get replies to...</p>
<pre><code>$ sh ../query.sh $(docker-machine ip ms-manager0)
$ sh ../query.sh $(docker-machine ip ms-worker1)
</code></pre>
<h2 id="networks-considerations">Networks considerations</h2>
<p>In this case, all containers are attached to the same overlay network (mongo-replica_replica) over which they communicate to each other. However, if you have a different configuration and are running any of the containers behind a firewall, remember to keep traffic open for TCP at ports 1026 (Orion's default) and 27017 (Mongo's default).</p>
<p>When containers (tasks) of a service are launched, they get assigned an IP address in this overlay network. Other services of your application's architecture should not be relying on these IPs because they may change (for example, due to a dynamic rescheduling). The good think is that docker creates a virtual ip for the service as a whole, so all traffic to this address will be load-balanced to the tasks adresses.</p>
<p>Thanks to swarms docker internal DNS you can also use the name of the service to connect to. If you look at the <em>docker-compose.yml</em> file of this recipe, orion is started with the name of the mongo service as <em>dbhost</em> param (regardless if it was a single mongo instance of a whole replica-set).</p>
<p>However, to access the container from outside of the overlay network (for example from the host) you would need to access the ip of the container's interface to the <em>docker_gwbridge</em>. It seem there's no easy way to get that information from the outside (see <a href="https://github.com/docker/libnetwork/issues/1082">this open issue</a>. In the walkthrough, we queried orion through one of the swarm nodes because we rely on docker ingress network routing the traffic all the way to one of the containerized orion services.</p>
<h2 id="open-interesting-issues">Open interesting issues:</h2>
<ul>
<li><a href="https://github.com/docker/swarm/issues/1106">https://github.com/docker/swarm/issues/1106</a></li>
<li><a href="https://github.com/docker/docker/issues/27082">https://github.com/docker/docker/issues/27082</a></li>
<li><a href="https://github.com/docker/docker/issues/29816">https://github.com/docker/docker/issues/29816</a></li>
<li><a href="https://github.com/docker/docker/issues/26696">https://github.com/docker/docker/issues/26696</a></li>
<li><a href="https://github.com/docker/docker/issues/23813">https://github.com/docker/docker/issues/23813</a></li>
</ul>
<p>More info about docker network internals can be read at:</p>
<ul>
<li><a href="https://success.docker.com/KBase/Docker_Reference_Architecture%3A_Designing_Scalable%2C_Portable_Docker_Container_Networks">Docker Reference Architecture</a></li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../../iot-services/readme/" class="btn btn-neutral float-right" title="IoT Broker">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../simple/readme/" class="btn btn-neutral" title="Simple"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/martel-innovate/smartsdk-recipes" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../simple/readme/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../../../iot-services/readme/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../../../js/theme.js"></script>

</body>
</html>
